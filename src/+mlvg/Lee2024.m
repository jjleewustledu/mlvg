classdef Lee2024 < handle & mlsystem.IHandle
    %% For manuscript to Physics in Biology & Medicine, 2024.
    %  
    %  Created 03-Jan-2024 21:45:43 by jjlee in repository /Users/jjlee/MATLAB-Drive/mlvg/src/+mlvg.
    %  Developed on Matlab 23.2.0.2459199 (R2023b) Update 5 for MACA64.  Copyright 2024 John J. Lee.
    
    properties
        
    end

    methods
        function draw_centerlines(this, row)            
            T = this.table_nii();
            pth = myfileparts(T.bids_fqfn(row));
            pth = strrep(pth, "sourcedata", "derivatives");
            pwd0 = pushd(pth);

            lett = ["x", "y", "z"];
            for ax = 3:-1:1
                tof = mglob(sprintf("tof_on_sub*_max%g.nii.gz", ax));
                mipt = mglob(sprintf("sub*createNiftiMovingAvgFrames_mipt_max%g.nii.gz", ax));
                assert(1 == length(tof));
                assert(1 == length(mipt));
                tof_ic = mlfourd.ImagingContext2(tof);
                mipt_ic = mlfourd.ImagingContext2(mipt);

                fprintf("Please draw arterial centerlines as overlaid images on the tof and mipt.\n" + ...
                    "Save files: centerline_%sl and centerline_%sr.\n\n", lett(ax));
                tof_ic.view(mipt_ic) 
            end

            popd(pwd0);
        end
        function call_ifk(this, row, opts)
            arguments
                this mlvg.Lee2024
                row double
                opts.steps logical = [1,1,0,0,0]
                opts.delete_large_files logical = false
            end

            try
                T = this.table_nii();
                bids_fqfn = T.bids_fqfn(row);
                if any(opts.steps(3:end)) % prep to use all time frames for IDIF
                    bids_fqfn = strrep(bids_fqfn, "-delay30-", "-delay0-");
                end
                assert(isfile(bids_fqfn)) % sanity
                deriv_pth = strrep(fileparts(bids_fqfn), "sourcedata", "derivatives");
                ensuredir(deriv_pth);
                %deleteExisting(fullfile(deriv_pth, "*proc-MipIdif*"))

                if strcmp(T.tracer(row), "fdg")
                    tracer_tags = "18F";
                else
                    tracer_tags = "15O";
                end

                ifk = mlkinetics.InputFuncKit.create_from_tags( ...
                    bids_fqfn=bids_fqfn, ...
                    bids_tags="ccir1211", ...
                    scanner_tags="vision", ...
                    tracer_tags=tracer_tags, ...
                    input_func_tags="mipidif");
                ifk.do_make_input_func( ...
                    steps=opts.steps, delete_large_files=opts.delete_large_files);
            catch ME
                handwarning(ME)
            end
        end
        function T = strrep_bids_fqfn(this, opts)
            arguments
                this
                opts.s1 {mustBeTextScalar} = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity")
                opts.s2 {mustBeTextScalar} = fullfile(getenv("SINGULARITY_HOME"))
            end
            
            T = this.table_nii;
            T.bids_fqfn = strrep(T.bids_fqfn, opts.s1, opts.s2);
            this.table_nii_ = T;
        end
        function T = table_nii(this)
            if ~isempty(this.table_nii_)
                T = this.table_nii_;
                return
            end

            bids_fqfn(1) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108293", "ses-20210421144815", "pet", ...
                "sub-108293_ses-20210421144815_trc-co_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(2) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108293", "ses-20210421150523", "pet", ...
                "sub-108293_ses-20210421150523_trc-oo_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(3) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108293", "ses-20210421152358", "pet", ...
                "sub-108293_ses-20210421152358_trc-ho_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(4) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108293", "ses-20210421154248", "pet", ...
                "sub-108293_ses-20210421154248_trc-oo_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(5) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
               "CCIR_01211", "sourcedata", "sub-108293", "ses-20210421155709", "pet", ...
               "sub-108293_ses-20210421155709_trc-fdg_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");           

            bids_fqfn(6) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108237", "ses-20221031100910", "pet", ...
                "sub-108237_ses-20221031100910_trc-co_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(7) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108237", "ses-20221031102320", "pet", ...
                "sub-108237_ses-20221031102320_trc-oo_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(8) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108237", "ses-20221031103712", "pet", ...
                "sub-108237_ses-20221031103712_trc-oo_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(9) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108237", "ses-20221031110638", "pet", ...
                "sub-108237_ses-20221031110638_trc-ho_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(10) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108237", "ses-20221031113804", "pet", ...
                "sub-108237_ses-20221031113804_trc-fdg_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
             
            bids_fqfn(11) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108254", "ses-20221116095143", "pet", ...
                "sub-108254_ses-20221116095143_trc-co_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(12) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108254", "ses-20221116100858", "pet", ...
                "sub-108254_ses-20221116100858_trc-oo_proc-delay30-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(13) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108254", "ses-20221116102328", "pet", ...
                "sub-108254_ses-20221116102328_trc-oo_proc-delay30-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(14) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108254", "ses-20221116104751", "pet", ...
                "sub-108254_ses-20221116104751_trc-ho_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(15) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108254", "ses-20221116115244", "pet", ...
                "sub-108254_ses-20221116115244_trc-fdg_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            
            bids_fqfn(16) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108250", "ses-20221207093856", "pet", ...
                "sub-108250_ses-20221207093856_trc-co_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(17) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108250", "ses-20221207095507", "pet", ...
                "sub-108250_ses-20221207095507_trc-oo_proc-delay30-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(18) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108250", "ses-20221207100946", "pet", ...
                "sub-108250_ses-20221207100946_trc-oo_proc-delay30-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(19) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108250", "ses-20221207102944", "pet", ...
                "sub-108250_ses-20221207102944_trc-ho_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(20) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108250", "ses-20221207104909", "pet", ...
                "sub-108250_ses-20221207104909_trc-fdg_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
             
            bids_fqfn(21) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108284", "ses-20230220093702", "pet", ...
                "sub-108284_ses-20230220093702_trc-co_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(22) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108284", "ses-20230220095210", "pet", ...
                "sub-108284_ses-20230220095210_trc-oo_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(23) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108284", "ses-20230220101103", "pet", ...
                "sub-108284_ses-20230220101103_trc-oo_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(24) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108284", "ses-20230220103226", "pet", ...
                "sub-108284_ses-20230220103226_trc-ho_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(25) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108284", "ses-20230220112328", "pet", ...
                "sub-108284_ses-20230220112328_trc-ho_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");

            bids_fqfn(26) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108306", "ses-20230227103048", "pet", ...
                "sub-108306_ses-20230227103048_trc-co_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(27) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108306", "ses-20230227104631", "pet", ...
                "sub-108306_ses-20230227104631_trc-oo_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(28) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108306", "ses-20230227112148", "pet", ...
                "sub-108306_ses-20230227112148_trc-oo_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(29) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108306", "ses-20230227113853", "pet", ...
                "sub-108306_ses-20230227113853_trc-ho_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz");
            bids_fqfn(30) = fullfile(getenv("HOME"), "mnt", "CHPC_scratch", "Singularity", ...
                "CCIR_01211", "sourcedata", "sub-108306", "ses-20230227115809", "pet", ...
                "sub-108306_ses-20230227115809_trc-fdg_proc-delay0-BrainMoCo2-createNiftiMovingAvgFrames.nii.gz"); 

            for row = 1:length(bids_fqfn)
                fp = mybasename(bids_fqfn(row));
                re = regexp(fp, "(?<sub>sub-\d{6})_(?<ses>ses-\d{14})_trc\-(?<tr>[a-z]+)_proc\S+", "names");
                sub(row) = re.sub;
                ses(row) = re.ses;
                tracer(row) = re.tr; %#ok<*AGROW>
            end
            bids_fqfn = ascol(bids_fqfn);
            sub = ascol(sub);
            ses = ascol(ses);       
            tracer = ascol(tracer);

            this.table_nii_ = table(sub, ses, bids_fqfn, tracer);
            T = this.table_nii_;
        end

        function this = Lee2024(varargin)
        end
    end
        
    %% PRIVATE

    properties (Access=private)
        table_nii_
    end
    
    %  Created with mlsystem.Newcl, inspired by Frank Gonzalez-Morphy's newfcn.
end
